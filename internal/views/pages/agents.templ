package pages

import "github.com/haatos/simple-ci/internal/views"
import "github.com/haatos/simple-ci/internal/store"
import "github.com/haatos/simple-ci/internal/views/components"
import "fmt"

templ AgentsPage(user *store.User, agents []*store.Agent, credentials []*store.Credential) {
	@views.Layout(user, views.LayoutProps{Title: "App"}) {
		@AgentsMain(agents, credentials)
	}
}

func agentCredentialIDSelectOptions(credentials []*store.Credential, credentialID int64) []components.SelectOption {
	options := make([]components.SelectOption, 0, len(credentials)+1)
	options = append(
		options,
		components.SelectOption{Label: "Select credentials...", Selected: true, Disabled: true},
	)
	for _, c := range credentials {
		options = append(
			options,
			components.SelectOption{
				Label:    fmt.Sprintf("%s - %.40s", c.Username, c.Description),
				Value:    fmt.Sprintf("%d", c.CredentialID),
				Selected: c.CredentialID == credentialID,
			})
	}
	return options
}

func agentOSTypeSelectOptions() []components.SelectOption {
	options := []components.SelectOption{
		{Label: "Select a OS type...", Value: "", Selected: true},
		{Label: "unix", Value: "unix"},
		{Label: "windows", Value: "windows"},
	}
	return options
}

templ AgentsMain(agents []*store.Agent, credentials []*store.Credential) {
	<main class="w-full p-4 border border-base-content/20 rounded-box space-y-4">
		@components.Modal(
			components.ModalProps{
				ID:    "add_agent_modal",
				Label: addAgentModalButton(templ.Attributes{"onclick": "add_agent_modal.showModal()"}, len(credentials)),
			}) {
			<h2 class="card-title">Add new agent</h2>
			@addNewAgentForm(credentials)
		}
		<div id="agents-grid" class="grid grid-cols-2 gap-4">
			for _, a := range agents {
				@AgentCard(a)
			}
		</div>
	</main>
}

templ addNewAgentForm(credentials []*store.Credential) {
	<form
		id="add-new-agent-form"
		hx-post="/app/agents"
		hx-target="#agents-grid"
		hx-swap="beforeend"
	>
		@components.Select(components.SelectProps{
			Label:    "Credentials*",
			Name:     "agent_credential_id",
			Options:  agentCredentialIDSelectOptions(credentials, 0),
			Required: true,
		})
		@components.Select(components.SelectProps{
			Label:    "OS Type*",
			Name:     "os_type",
			Options:  agentOSTypeSelectOptions(),
			Required: true,
		})
		@components.Input(components.InputProps{
			Label:       "Name*",
			Name:        "name",
			Placeholder: "Enter a name...",
			Required:    true,
		})
		@components.Input(components.InputProps{
			Label:         "Hostname*",
			Name:          "hostname",
			Placeholder:   "Enter a hostname...",
			Pattern:       `^(?:(?=.*[a-zA-Z])(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])|(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])|\[(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\])(?::\d{1,5})?$`,
			ValidatorHint: "must be a valid hostname",
			Required:      true,
		})
		@components.Input(components.InputProps{
			Label:       "Workspace*",
			Name:        "workspace",
			Placeholder: "Enter a workspace path...",
			Required:    true,
		})
		@components.Textarea(components.TextareaProps{
			Label:       "Description",
			Name:        "description",
			Placeholder: "Enter a description...",
			Rows:        3,
			Class:       "resize-none"})
		<script>
            document.addEventListener("htmx:afterRequest", function(evt) {
                if (evt.detail.elt.id === "add-new-agent-form" && !evt.detail.target.className.includes("modal")) {
                    add_agent_modal.close()
                }
            })
        </script>
	</form>
	<div class="flex justify-between items-center mt-8">
		<form method="dialog">
			<button class="btn">Close</button>
		</form>
		<button form="add-new-agent-form" type="submit" class="btn btn-primary">Add</button>
	</div>
}

templ addAgentModalButton(attrs templ.Attributes, credentialCount int) {
	if credentialCount == 0 {
		@components.Tooltip(components.TooltipProps{Tip: "Add credentials first"}) {
			<div { attrs... } class="btn btn-outline">
				Add agent 
			</div>
		}
	} else {
		<div { attrs... } class="btn btn-outline">
			Add agent 
		</div>
	}
}

templ AgentCard(a *store.Agent) {
	@components.Card(
		components.CardProps{
			Title:     a.Name,
			TitleIcon: views.AgentsIcon(),
			Content:   a.Description,
			Class:     "border border-base-content/20 rounded-box",
		}) {
		<div class="w-full flex justify-between items-center">
			@components.Tooltip(components.TooltipProps{
				Tip: "Test SSH connection",
			}) {
				<button
					class="btn btn-sm btn-ghost"
					onclick="this.toggleAttribute('disabled')"
					hx-post={ fmt.Sprintf("/app/agents/%d/test-connection", a.AgentID) }
					hx-swap="none"
				>
					<svg class="h-6 w-6 fill-base-content" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg">
						<path class="stroke-2" d="M16 12.25c-2.071 0-3.75 1.679-3.75 3.75s1.679 3.75 3.75 3.75c2.071 0 3.75-1.679 3.75-3.75v0c-0.003-2.070-1.68-3.747-3.75-3.75h-0zM16 18.25c-1.243 0-2.25-1.007-2.25-2.25s1.007-2.25 2.25-2.25c1.243 0 2.25 1.007 2.25 2.25v0c-0.002 1.242-1.008 2.248-2.25 2.25h-0zM2.75 16c0.213-3.554 1.667-6.732 3.93-9.142l-0.007 0.008c0.131-0.135 0.212-0.319 0.212-0.522 0-0.414-0.336-0.75-0.75-0.75-0.204 0-0.388 0.081-0.524 0.213l0-0c-2.542 2.664-4.167 6.222-4.36 10.157l-0.001 0.037c0.195 3.972 1.82 7.53 4.367 10.202l-0.006-0.006c0.135 0.131 0.319 0.212 0.523 0.212 0.414 0 0.75-0.336 0.75-0.75 0-0.203-0.081-0.388-0.213-0.523l0 0c-2.259-2.4-3.714-5.58-3.92-9.095l-0.002-0.040zM8.863 16c0.151-2.479 1.166-4.697 2.744-6.379l-0.005 0.005c0.131-0.135 0.212-0.319 0.212-0.522 0-0.414-0.336-0.75-0.75-0.75-0.204 0-0.388 0.081-0.523 0.213l0-0c-1.853 1.943-3.037 4.537-3.177 7.406l-0.001 0.027c0.14 2.895 1.325 5.489 3.182 7.436l-0.004-0.005c0.136 0.138 0.325 0.223 0.533 0.223 0.414 0 0.749-0.335 0.749-0.749 0-0.208-0.085-0.396-0.222-0.532l-0-0c-1.577-1.674-2.592-3.893-2.737-6.345l-0.001-0.028zM26.391 5.807c-0.136-0.135-0.322-0.218-0.528-0.218-0.414 0-0.75 0.336-0.75 0.75 0 0.205 0.083 0.392 0.216 0.527l-0-0c2.255 2.402 3.709 5.58 3.92 9.093l0.002 0.040c-0.213 3.554-1.666 6.733-3.929 9.143l0.007-0.008c-0.14 0.136-0.226 0.326-0.226 0.537 0 0.414 0.336 0.75 0.75 0.75 0.211 0 0.402-0.087 0.539-0.228l0-0c2.541-2.665 4.166-6.222 4.358-10.157l0.001-0.037c-0.194-3.971-1.819-7.529-4.365-10.2l0.006 0.006zM20.398 8.567c-0.136 0.136-0.22 0.323-0.22 0.531 0 0.206 0.083 0.393 0.218 0.529l-0-0c1.574 1.676 2.589 3.893 2.739 6.344l0.001 0.029c-0.152 2.48-1.167 4.697-2.745 6.378l0.005-0.005c-0.134 0.136-0.218 0.322-0.218 0.528 0 0.415 0.336 0.751 0.751 0.751 0.207 0 0.394-0.083 0.529-0.218l-0 0c1.852-1.944 3.036-4.538 3.177-7.407l0.001-0.027c-0.14-2.896-1.325-5.491-3.184-7.437l0.004 0.004c-0.135-0.136-0.323-0.22-0.529-0.22s-0.394 0.084-0.529 0.22l-0 0z"></path>
					</svg>
					<script>
                        ((btn) => {
                            document.addEventListener("htmx:afterRequest", (evt) => {
                                if (evt.detail.elt == btn) {
                                    btn.classList.toggle("disabled");
                                }
                            })
                            btn.addEventListener("click", () => {
                                btn.toggleAttribute("disabled");
                            })
                        })(document.currentScript.parentElement)
                    </script>
				</button>
			}
			@components.Tooltip(components.TooltipProps{Tip: "Edit agent"}) {
				<a
					{ views.NavigationLinkAttrs(fmt.Sprintf("/app/agents/%d", a.AgentID))... }
					class="btn btn-sm btn-ghost"
				>
					@views.EditIcon()
				</a>
			}
		</div>
	}
}
